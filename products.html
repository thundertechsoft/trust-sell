<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - Trust Sell</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-shield-alt"></i> Trust Sell
            </div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="ðŸ” Search products...">
            </div>
            <div class="nav-links">
                <a href="auth.html" class="auth-link">Login</a>
                <a href="index.html">Home</a>
                <a href="post-ad.html" class="btn btn-primary">Sell Now</a>
            </div>
        </div>
    </nav>

    <!-- Products Container -->
    <div class="products-container">
        <!-- Filters Sidebar -->
        <div class="filters-sidebar">
            <h2 style="margin-bottom: 2rem; color: var(--primary);">Filters</h2>
            
            <!-- Price Range -->
            <div class="filter-group">
                <h4>Price Range</h4>
                <input type="range" class="price-range" min="0" max="10000000" value="5000000" id="priceRange">
                <div class="price-inputs">
                    <input type="number" id="minPrice" placeholder="Min" value="0">
                    <input type="number" id="maxPrice" placeholder="Max" value="10000000">
                </div>
            </div>

            <!-- Categories -->
            <div class="filter-group">
                <h4>Categories</h4>
                <div class="category-list">
                    <label class="category-item">
                        <input type="checkbox" value="cars" class="category-filter">
                        <i class="fas fa-car"></i> Cars & Vehicles
                    </label>
                    <label class="category-item">
                        <input type="checkbox" value="mobiles" class="category-filter">
                        <i class="fas fa-mobile-alt"></i> Mobiles & Tablets
                    </label>
                    <label class="category-item">
                        <input type="checkbox" value="property" class="category-filter">
                        <i class="fas fa-home"></i> Property
                    </label>
                    <label class="category-item">
                        <input type="checkbox" value="jobs" class="category-filter">
                        <i class="fas fa-briefcase"></i> Jobs
                    </label>
                    <label class="category-item">
                        <input type="checkbox" value="bikes" class="category-filter">
                        <i class="fas fa-motorcycle"></i> Bikes
                    </label>
                    <label class="category-item">
                        <input type="checkbox" value="electronics" class="category-filter">
                        <i class="fas fa-laptop"></i> Electronics
                    </label>
                    <label class="category-item">
                        <input type="checkbox" value="fashion" class="category-filter">
                        <i class="fas fa-tshirt"></i> Fashion
                    </label>
                    <label class="category-item">
                        <input type="checkbox" value="furniture" class="category-filter">
                        <i class="fas fa-couch"></i> Furniture
                    </label>
                </div>
            </div>

            <!-- Location -->
            <div class="filter-group">
                <h4>Location</h4>
                <select class="location-filter" id="locationFilter">
                    <option value="">All Pakistan</option>
                    <option value="Karachi">Karachi</option>
                    <option value="Lahore">Lahore</option>
                    <option value="Islamabad">Islamabad</option>
                    <option value="Rawalpindi">Rawalpindi</option>
                    <option value="Faisalabad">Faisalabad</option>
                    <option value="Multan">Multan</option>
                    <option value="Peshawar">Peshawar</option>
                </select>
            </div>

            <!-- Seller Type -->
            <div class="filter-group">
                <h4>Seller Type</h4>
                <label class="filter-option">
                    <input type="checkbox" id="verifiedOnly"> Verified Sellers Only
                </label>
                <label class="filter-option">
                    <input type="checkbox" id="individualSellers"> Individual
                </label>
                <label class="filter-option">
                    <input type="checkbox" id="businessSellers"> Business
                </label>
            </div>

            <!-- Condition -->
            <div class="filter-group">
                <h4>Condition</h4>
                <label class="filter-option">
                    <input type="checkbox" value="new" class="condition-filter"> Brand New
                </label>
                <label class="filter-option">
                    <input type="checkbox" value="like-new" class="condition-filter"> Like New
                </label>
                <label class="filter-option">
                    <input type="checkbox" value="used" class="condition-filter"> Used
                </label>
                <label class="filter-option">
                    <input type="checkbox" value="refurbished" class="condition-filter"> Refurbished
                </label>
            </div>

            <button class="btn btn-primary" onclick="applyFilters()" style="width: 100%;">
                Apply Filters
            </button>
            <button class="btn btn-outline" onclick="resetFilters()" style="width: 100%; margin-top: 1rem;">
                Reset Filters
            </button>
        </div>

        <!-- Products Main -->
        <div class="products-main">
            <!-- Search and Sort -->
            <div class="search-sort">
                <div style="font-size: 1.2rem; color: var(--dark);">
                    <strong id="productsCount">0</strong> Products Found
                </div>
                <div class="sort-options">
                    <select id="sortBy" onchange="sortProducts()">
                        <option value="newest">Sort by: Newest First</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                        <option value="popular">Most Popular</option>
                    </select>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="products-grid" id="productsGrid">
                <!-- Products will be loaded here -->
            </div>

            <!-- Loading More -->
            <div id="loadingMore" style="display: none; text-align: center; padding: 2rem;">
                <div class="loading"></div>
                <p>Loading more products...</p>
            </div>

            <!-- No Results -->
            <div id="noResults" style="display: none; text-align: center; padding: 3rem; color: #666;">
                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; color: #ddd;"></i>
                <h3>No products found</h3>
                <p>Try adjusting your search filters</p>
                <button class="btn btn-primary" onclick="resetFilters()">Reset Filters</button>
            </div>

            <!-- Pagination -->
            <div class="pagination" id="pagination">
                <!-- Pagination will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="script.js"></script>

    <script>
        let allProducts = [];
        let filteredProducts = [];
        let currentPage = 1;
        const productsPerPage = 12;
        let currentSort = 'newest';
        let lastVisible = null;
        let hasMoreProducts = true;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            checkUrlParams();
            loadProducts();
            setupEventListeners();
        });

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('search');
            const category = urlParams.get('category');
            
            if (searchQuery) {
                document.getElementById('searchInput').value = searchQuery;
            }
            
            if (category) {
                // Check the category checkbox
                const categoryCheckbox = document.querySelector(`.category-filter[value="${category}"]`);
                if (categoryCheckbox) {
                    categoryCheckbox.checked = true;
                }
            }
        }

        function setupEventListeners() {
            // Price range slider
            const priceRange = document.getElementById('priceRange');
            const minPrice = document.getElementById('minPrice');
            const maxPrice = document.getElementById('maxPrice');

            priceRange.addEventListener('input', function() {
                maxPrice.value = this.value;
            });

            minPrice.addEventListener('input', function() {
                priceRange.value = this.value;
            });

            maxPrice.addEventListener('input', function() {
                priceRange.value = this.value;
            });

            // Search input
            document.getElementById('searchInput').addEventListener('input', debounce(function(e) {
                filterProducts();
            }, 500));

            // Filter changes
            document.querySelectorAll('.category-filter, .location-filter, .condition-filter, #verifiedOnly, #individualSellers, #businessSellers')
                .forEach(filter => {
                    filter.addEventListener('change', filterProducts);
                });

            // Infinite scroll
            window.addEventListener('scroll', handleScroll);
        }

        async function loadProducts() {
            showLoading('Loading products...');
            
            try {
                let query = db.collection('products')
                    .where('status', '==', 'active')
                    .orderBy('createdAt', 'desc')
                    .limit(productsPerPage);

                const querySnapshot = await query.get();
                
                allProducts = [];
                querySnapshot.forEach((doc) => {
                    allProducts.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];
                hasMoreProducts = querySnapshot.docs.length === productsPerPage;

                displayProducts(allProducts);
                updateProductsCount(allProducts.length);
                
            } catch (error) {
                console.error('Error loading products:', error);
                showNotification('Error loading products', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadMoreProducts() {
            if (!hasMoreProducts) return;

            document.getElementById('loadingMore').style.display = 'block';

            try {
                let query = db.collection('products')
                    .where('status', '==', 'active')
                    .orderBy('createdAt', 'desc')
                    .startAfter(lastVisible)
                    .limit(productsPerPage);

                const querySnapshot = await query.get();
                
                const newProducts = [];
                querySnapshot.forEach((doc) => {
                    newProducts.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                allProducts = [...allProducts, ...newProducts];
                lastVisible = querySnapshot.docs[querySnapshot.docs.length - 1];
                hasMoreProducts = querySnapshot.docs.length === productsPerPage;

                filterProducts(); // Re-apply filters to include new products
                
            } catch (error) {
                console.error('Error loading more products:', error);
                showNotification('Error loading more products', 'error');
            } finally {
                document.getElementById('loadingMore').style.display = 'none';
            }
        }

        function filterProducts() {
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked')).map(cb => cb.value);
            const location = document.getElementById('locationFilter').value;
            const minPrice = parseInt(document.getElementById('minPrice').value) || 0;
            const maxPrice = parseInt(document.getElementById('maxPrice').value) || 10000000;
            const verifiedOnly = document.getElementById('verifiedOnly').checked;
            const selectedConditions = Array.from(document.querySelectorAll('.condition-filter:checked')).map(cb => cb.value);

            filteredProducts = allProducts.filter(product => {
                // Search filter
                if (searchQuery && !product.title.toLowerCase().includes(searchQuery) && 
                    !product.description.toLowerCase().includes(searchQuery)) {
                    return false;
                }

                // Category filter
                if (selectedCategories.length > 0 && !selectedCategories.includes(product.category)) {
                    return false;
                }

                // Location filter
                if (location && product.location !== location) {
                    return false;
                }

                // Price filter
                if (product.price < minPrice || product.price > maxPrice) {
                    return false;
                }

                // Verified seller filter
                if (verifiedOnly && !product.sellerVerified) {
                    return false;
                }

                // Condition filter
                if (selectedConditions.length > 0 && !selectedConditions.includes(product.condition)) {
                    return false;
                }

                return true;
            });

            sortProducts();
            updateProductsCount(filteredProducts.length);
        }

        function sortProducts() {
            currentSort = document.getElementById('sortBy').value;
            
            switch (currentSort) {
                case 'price-low':
                    filteredProducts.sort((a, b) => a.price - b.price);
                    break;
                case 'price-high':
                    filteredProducts.sort((a, b) => b.price - a.price);
                    break;
                case 'popular':
                    filteredProducts.sort((a, b) => (b.views || 0) - (a.views || 0));
                    break;
                case 'newest':
                default:
                    filteredProducts.sort((a, b) => b.createdAt - a.createdAt);
                    break;
            }

            displayProducts(filteredProducts);
        }

        function displayProducts(products) {
            const productsGrid = document.getElementById('productsGrid');
            const noResults = document.getElementById('noResults');
            
            if (products.length === 0) {
                productsGrid.innerHTML = '';
                noResults.style.display = 'block';
                return;
            }

            noResults.style.display = 'none';
            productsGrid.innerHTML = '';

            // Display products for current page
            const startIndex = (currentPage - 1) * productsPerPage;
            const endIndex = startIndex + productsPerPage;
            const productsToShow = products.slice(startIndex, endIndex);

            productsToShow.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.onclick = () => viewProduct(product.id);
                
                productCard.innerHTML = `
                    <div class="product-image">
                        <i class="fas fa-${getCategoryIcon(product.category)}"></i>
                        ${product.sellerVerified ? '<div class="product-badge">Verified</div>' : ''}
                        ${product.features && product.features.includes('featured') ? '<div class="premium-badge">Featured</div>' : ''}
                    </div>
                    <div class="product-content">
                        <h3 class="product-title">${product.title}</h3>
                        <div class="product-price">${formatPrice(product.price)}</div>
                        <div class="product-location">
                            <i class="fas fa-map-marker-alt"></i> ${product.location}
                        </div>
                        <div class="product-meta">
                            <div class="seller-info">
                                <div class="seller-avatar">${getInitials(product.sellerName)}</div>
                                <span>${product.sellerName}</span>
                                ${product.sellerVerified ? '<i class="fas fa-badge-check verified-icon"></i>' : ''}
                            </div>
                            <div class="product-actions">
                                <button class="action-btn like-btn" onclick="event.stopPropagation(); toggleFavorite('${product.id}')">
                                    <i class="far fa-heart"></i>
                                </button>
                                <button class="action-btn" onclick="event.stopPropagation(); contactSeller('${product.sellerId}')">
                                    <i class="far fa-envelope"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                productsGrid.appendChild(productCard);
            });

            updatePagination(products.length);
        }

        function updateProductsCount(count) {
            document.getElementById('productsCount').textContent = count;
        }

        function updatePagination(totalProducts) {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(totalProducts / productsPerPage);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHTML = '';
            
            // Previous button
            if (currentPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;
            }

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<button class="page-btn active">${i}</button>`;
                } else {
                    paginationHTML += `<button class="page-btn" onclick="changePage(${i})">${i}</button>`;
                }
            }

            // Next button
            if (currentPage < totalPages) {
                paginationHTML += `<button class="page-btn" onclick="changePage(${currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;
            }

            pagination.innerHTML = paginationHTML;
        }

        function changePage(page) {
            currentPage = page;
            displayProducts(filteredProducts.length > 0 ? filteredProducts : allProducts);
            window.scrollTo(0, 0);
        }

        function applyFilters() {
            currentPage = 1;
            filterProducts();
        }

        function resetFilters() {
            // Reset all filters
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('.category-filter').forEach(cb => cb.checked = false);
            document.getElementById('locationFilter').value = '';
            document.getElementById('minPrice').value = '0';
            document.getElementById('maxPrice').value = '10000000';
            document.getElementById('priceRange').value = '5000000';
            document.getElementById('verifiedOnly').checked = false;
            document.querySelectorAll('.condition-filter').forEach(cb => cb.checked = false);
            document.getElementById('sortBy').value = 'newest';
            
            currentPage = 1;
            filteredProducts = [];
            displayProducts(allProducts);
            updateProductsCount(allProducts.length);
        }

        function handleScroll() {
            const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
            
            if (scrollTop + clientHeight >= scrollHeight - 100 && hasMoreProducts) {
                loadMoreProducts();
            }
        }

        // Add CSS for pagination and filters
        const style = document.createElement('style');
        style.textContent = `
            .category-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.8rem 0;
                cursor: pointer;
                border-bottom: 1px solid #eee;
            }
            
            .filter-option {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem 0;
                cursor: pointer;
            }
            
            .page-btn {
                padding: 0.8rem 1.2rem;
                border: none;
                border-radius: 10px;
                background: white;
                color: var(--dark);
                cursor: pointer;
                transition: all 0.3s ease;
                margin: 0 0.2rem;
            }
            
            .page-btn.active {
                background: var(--gradient);
                color: white;
            }
            
            .page-btn:hover:not(.active) {
                background: var(--light);
            }
            
            .pagination {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
                margin-top: 3rem;
                flex-wrap: wrap;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
