<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post New Ad - Trust Sell</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-shield-alt"></i> Trust Sell
            </div>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="products.html">Browse</a>
                <a href="auth.html" class="auth-link">Login</a>
            </div>
        </div>
    </nav>

    <!-- Post Ad Container -->
    <div class="post-ad-container">
        <div class="post-ad-card">
            <div class="form-header text-center mb-3">
                <h1>Sell Your Item</h1>
                <p>Reach thousands of buyers on Trust Sell</p>
            </div>

            <!-- Form Steps -->
            <div class="form-steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Basic Info</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Details</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Photos</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Review</div>
                </div>
            </div>

            <!-- Step 1: Basic Information -->
            <div class="form-section active" id="step1">
                <div class="form-group">
                    <label for="category">Category *</label>
                    <select id="category" required>
                        <option value="">Select Category</option>
                        <option value="cars">Cars & Vehicles</option>
                        <option value="mobiles">Mobiles & Tablets</option>
                        <option value="property">Property</option>
                        <option value="jobs">Jobs</option>
                        <option value="bikes">Bikes</option>
                        <option value="electronics">Electronics</option>
                        <option value="fashion">Fashion</option>
                        <option value="furniture">Furniture</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="title">Ad Title *</label>
                    <input type="text" id="title" placeholder="e.g., iPhone 14 Pro Max 256GB Brand New" required maxlength="100">
                    <small style="color: #666; margin-top: 0.5rem; display: block;">Maximum 100 characters</small>
                </div>

                <div class="form-group">
                    <label for="description">Description *</label>
                    <textarea id="description" placeholder="Describe your item in detail..." required minlength="50" maxlength="1000"></textarea>
                    <small style="color: #666; margin-top: 0.5rem; display: block;">Minimum 50 characters, Maximum 1000 characters</small>
                </div>

                <div class="form-actions">
                    <div></div>
                    <button class="btn btn-primary" onclick="validateStep1()">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 2: Details -->
            <div class="form-section" id="step2">
                <div class="form-group">
                    <label for="price">Price *</label>
                    <div class="price-input" style="position: relative;">
                        <span style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #666; font-weight: 600;">Rs</span>
                        <input type="number" id="price" placeholder="0" required min="1" style="padding-left: 3rem;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="condition">Condition *</label>
                    <select id="condition" required>
                        <option value="">Select Condition</option>
                        <option value="new">Brand New</option>
                        <option value="like-new">Like New</option>
                        <option value="used">Used</option>
                        <option value="refurbished">Refurbished</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="location">Location *</label>
                    <select id="location" required>
                        <option value="">Select City</option>
                        <option value="Karachi">Karachi</option>
                        <option value="Lahore">Lahore</option>
                        <option value="Islamabad">Islamabad</option>
                        <option value="Rawalpindi">Rawalpindi</option>
                        <option value="Faisalabad">Faisalabad</option>
                        <option value="Multan">Multan</option>
                        <option value="Peshawar">Peshawar</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Ad Features</label>
                    <div class="feature-options" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="feature-option" onclick="toggleFeature(this, 'featured')">
                            <i class="fas fa-star"></i>
                            <h4>Featured Ad</h4>
                            <p>Get 3x more views</p>
                            <small>Rs 500</small>
                        </div>
                        <div class="feature-option" onclick="toggleFeature(this, 'urgent')">
                            <i class="fas fa-bolt"></i>
                            <h4>Urgent Ad</h4>
                            <p>Sell faster</p>
                            <small>Rs 300</small>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn btn-outline" onclick="prevStep(1)">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" onclick="validateStep2()">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Photos -->
            <div class="form-section" id="step3">
                <div class="form-group">
                    <label>Upload Photos *</label>
                    <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Click to Upload Images</h3>
                        <p>Add up to 12 photos. First image will be the cover.</p>
                    </div>
                    <input type="file" id="imageInput" multiple accept="image/*" style="display: none;">
                    
                    <div class="image-preview" id="imagePreview">
                        <!-- Images will be previewed here -->
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn btn-outline" onclick="prevStep(2)">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" onclick="validateStep3()">
                        Next <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Step 4: Review -->
            <div class="form-section" id="step4">
                <div class="form-group">
                    <h3 class="text-center mb-2">Review Your Ad</h3>
                    
                    <div style="background: var(--light); padding: 2rem; border-radius: 10px; margin-bottom: 2rem;">
                        <h4 id="reviewTitle" style="margin-bottom: 1rem;">Ad Title</h4>
                        <p id="reviewDescription" style="margin-bottom: 1rem; color: #666;">Description will appear here</p>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span id="reviewPrice" style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">Rs 0</span>
                            <span id="reviewLocation" style="color: #666;">Location</span>
                        </div>
                        <div id="reviewFeatures" style="margin-top: 1rem;"></div>
                    </div>

                    <div class="form-group">
                        <label for="contactNumber">Contact Number *</label>
                        <input type="tel" id="contactNumber" placeholder="+92 300 1234567" required>
                    </div>

                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="agreeTerms" required>
                            I agree to the <a href="#" style="color: var(--primary);">Terms & Conditions</a>
                        </label>
                    </div>
                </div>

                <div class="form-actions">
                    <button class="btn btn-outline" onclick="prevStep(3)">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-primary" onclick="submitAd()" id="submitBtn">
                        <i class="fas fa-paper-plane"></i> Publish Ad
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="script.js"></script>

    <script>
        let currentStep = 1;
        let selectedFeatures = [];
        let uploadedImages = [];

        // Check authentication
        auth.onAuthStateChanged((user) => {
            if (!user) {
                showNotification('Please login to post an ad', 'warning');
                setTimeout(() => {
                    window.location.href = 'auth.html';
                }, 2000);
            }
        });

        function showStep(step) {
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById('step' + step).classList.add('active');

            document.querySelectorAll('.step').forEach(stepEl => {
                stepEl.classList.remove('active');
                if (parseInt(stepEl.dataset.step) === step) {
                    stepEl.classList.add('active');
                }
                if (parseInt(stepEl.dataset.step) < step) {
                    stepEl.classList.add('completed');
                }
            });
        }

        function nextStep(step) {
            currentStep = step;
            showStep(step);
            updateReview();
        }

        function prevStep(step) {
            currentStep = step;
            showStep(step);
        }

        function validateStep1() {
            const category = document.getElementById('category').value;
            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();

            if (!category) {
                showNotification('Please select a category', 'error');
                return;
            }

            if (!title || title.length < 10) {
                showNotification('Title must be at least 10 characters', 'error');
                return;
            }

            if (!description || description.length < 50) {
                showNotification('Description must be at least 50 characters', 'error');
                return;
            }

            nextStep(2);
        }

        function validateStep2() {
            const price = document.getElementById('price').value;
            const condition = document.getElementById('condition').value;
            const location = document.getElementById('location').value;

            if (!price || price < 1) {
                showNotification('Please enter a valid price', 'error');
                return;
            }

            if (!condition) {
                showNotification('Please select condition', 'error');
                return;
            }

            if (!location) {
                showNotification('Please select location', 'error');
                return;
            }

            nextStep(3);
        }

        function validateStep3() {
            if (uploadedImages.length === 0) {
                showNotification('Please upload at least one image', 'error');
                return;
            }

            nextStep(4);
        }

        function toggleFeature(element, feature) {
            element.classList.toggle('selected');
            
            if (element.classList.contains('selected')) {
                selectedFeatures.push(feature);
            } else {
                const index = selectedFeatures.indexOf(feature);
                if (index > -1) selectedFeatures.splice(index, 1);
            }
            
            updateReview();
        }

        function updateReview() {
            document.getElementById('reviewTitle').textContent = 
                document.getElementById('title').value || 'Ad Title';
            document.getElementById('reviewDescription').textContent = 
                document.getElementById('description').value || 'Description will appear here';
            document.getElementById('reviewPrice').textContent = 
                'Rs ' + (document.getElementById('price').value || '0');
            document.getElementById('reviewLocation').textContent = 
                document.getElementById('location').options[document.getElementById('location').selectedIndex]?.text || 'Location';
            
            // Update features
            const featuresContainer = document.getElementById('reviewFeatures');
            if (selectedFeatures.length > 0) {
                featuresContainer.innerHTML = `
                    <div style="margin-top: 1rem;">
                        <strong>Features:</strong> ${selectedFeatures.map(f => f.charAt(0).toUpperCase() + f.slice(1)).join(', ')}
                    </div>
                `;
            } else {
                featuresContainer.innerHTML = '';
            }
        }

        // Image upload functionality
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const preview = document.getElementById('imagePreview');
            const files = Array.from(e.target.files);
            
            if (files.length + uploadedImages.length > 12) {
                showNotification('Maximum 12 images allowed', 'error');
                return;
            }

            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = {
                            file: file,
                            url: e.target.result
                        };
                        uploadedImages.push(imageData);
                        displayImagePreview(imageData, uploadedImages.length - 1);
                    };
                    reader.readAsDataURL(file);
                }
            });
        });

        function displayImagePreview(imageData, index) {
            const preview = document.getElementById('imagePreview');
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
                <img src="${imageData.url}" alt="Preview">
                <button class="remove-image" onclick="removeImage(${index})" style="position: absolute; top: 5px; right: 5px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            preview.appendChild(previewItem);
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            document.getElementById('imagePreview').innerHTML = '';
            uploadedImages.forEach((image, i) => displayImagePreview(image, i));
        }

        async function submitAd() {
            if (!document.getElementById('agreeTerms').checked) {
                showNotification('Please agree to the terms and conditions', 'error');
                return;
            }

            const contactNumber = document.getElementById('contactNumber').value.trim();
            if (!contactNumber) {
                showNotification('Please enter contact number', 'error');
                return;
            }

            showLoading('Publishing your ad...');

            try {
                // Upload images to Firebase Storage
                const imageUrls = [];
                for (const imageData of uploadedImages) {
                    const imageUrl = await uploadImage(imageData.file);
                    imageUrls.push(imageUrl);
                }

                // Save product data to Firestore
                const productData = {
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    price: parseInt(document.getElementById('price').value),
                    category: document.getElementById('category').value,
                    condition: document.getElementById('condition').value,
                    location: document.getElementById('location').value,
                    contactNumber: contactNumber,
                    images: imageUrls,
                    features: selectedFeatures,
                    sellerId: AppState.currentUser.uid,
                    sellerName: AppState.userData.name,
                    sellerVerified: AppState.userData.verified || false,
                    status: 'active',
                    views: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await db.collection('products').add(productData);
                
                showNotification('Ad published successfully!', 'success');
                
                setTimeout(() => {
                    window.location.href = 'profile.html';
                }, 2000);

            } catch (error) {
                console.error('Error publishing ad:', error);
                showNotification('Error publishing ad. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        async function uploadImage(file) {
            const storageRef = storage.ref();
            const imageRef = storageRef.child(`products/${Date.now()}_${file.name}`);
            await imageRef.put(file);
            return await imageRef.getDownloadURL();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Add input listeners for real-time review update
            document.getElementById('title').addEventListener('input', updateReview);
            document.getElementById('description').addEventListener('input', updateReview);
            document.getElementById('price').addEventListener('input', updateReview);
            document.getElementById('location').addEventListener('change', updateReview);
        });
    </script>
</body>
</html>
