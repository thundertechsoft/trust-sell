<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - Trust Sell</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-shield-alt"></i> Trust Sell
            </div>
            <div class="search-bar">
                <input type="text" placeholder="ðŸ” Search conversations...">
            </div>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="products.html">Browse</a>
                <a href="profile.html" class="auth-link">Login</a>
            </div>
        </div>
    </nav>

    <!-- Chat Container -->
    <div class="chat-container">
        <!-- Conversations Sidebar -->
        <div class="chat-sidebar">
            <div class="sidebar-header" style="padding: 2rem; border-bottom: 2px solid #eee;">
                <h2 style="margin-bottom: 1rem;">Messages</h2>
                <div class="search-bar">
                    <input type="text" placeholder="Search conversations...">
                </div>
            </div>

            <div class="chat-list" id="conversationsList">
                <!-- Conversations will be loaded here -->
                <div class="text-center" style="padding: 3rem; color: #666;">
                    <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem; color: #ddd;"></i>
                    <h4>No conversations yet</h4>
                    <p>Start a conversation by contacting a seller</p>
                </div>
            </div>
        </div>

        <!-- Chat Window -->
        <div class="chat-main">
            <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem; border-bottom: 2px solid #eee;">
                <div id="chatHeader">
                    <div class="text-center" style="padding: 3rem; color: #666;">
                        <i class="fas fa-comment" style="font-size: 3rem; margin-bottom: 1rem; color: #ddd;"></i>
                        <h4>Select a conversation</h4>
                        <p>Choose a chat from the sidebar to start messaging</p>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="messagesContainer" style="display: none;">
                <!-- Messages will be loaded here -->
            </div>

            <div class="chat-input" id="messageInputContainer" style="display: none;">
                <input type="text" id="messageInput" placeholder="Type a message...">
                <button class="btn btn-primary" onclick="sendMessage()" style="padding: 12px 20px;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="script.js"></script>

    <script>
        let currentChatId = null;
        let unsubscribeMessages = null;

        // Check if user is logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadConversations();
                checkUrlParams();
            } else {
                showNotification('Please login to view messages', 'warning');
                setTimeout(() => {
                    window.location.href = 'auth.html';
                }, 2000);
            }
        });

        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const sellerId = urlParams.get('seller');
            
            if (sellerId) {
                startNewChat(sellerId);
            }
        }

        async function loadConversations() {
            const conversationsList = document.getElementById('conversationsList');
            
            try {
                const chatsSnapshot = await db.collection('chats')
                    .where('participants', 'array-contains', AppState.currentUser.uid)
                    .orderBy('lastMessageTime', 'desc')
                    .get();

                if (chatsSnapshot.empty) {
                    conversationsList.innerHTML = `
                        <div class="text-center" style="padding: 3rem; color: #666;">
                            <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem; color: #ddd;"></i>
                            <h4>No conversations yet</h4>
                            <p>Start a conversation by contacting a seller</p>
                        </div>
                    `;
                    return;
                }

                conversationsList.innerHTML = '';
                
                chatsSnapshot.forEach((doc) => {
                    const chat = doc.data();
                    const otherParticipantId = chat.participants.find(id => id !== AppState.currentUser.uid);
                    const otherParticipant = chat.participantsData[otherParticipantId];
                    
                    const conversationItem = document.createElement('div');
                    conversationItem.className = 'chat-item';
                    conversationItem.onclick = () => loadChat(doc.id, otherParticipantId);
                    
                    conversationItem.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div class="seller-avatar" style="width: 50px; height: 50px; font-size: 1.2rem;">
                                ${getInitials(otherParticipant.name)}
                            </div>
                            <div style="flex: 1;">
                                <h4 style="margin-bottom: 0.3rem;">${otherParticipant.name}</h4>
                                <p style="color: #666; font-size: 0.9rem; margin: 0;">${chat.lastMessage || 'No messages yet'}</p>
                            </div>
                            <div style="text-align: right;">
                                <small style="color: #666;">${formatDate(chat.lastMessageTime)}</small>
                            </div>
                        </div>
                    `;
                    
                    conversationsList.appendChild(conversationItem);
                });
                
            } catch (error) {
                console.error('Error loading conversations:', error);
                showNotification('Error loading conversations', 'error');
            }
        }

        async function loadChat(chatId, otherUserId) {
            currentChatId = chatId;
            
            // Update UI
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.chat-item').classList.add('active');
            
            // Load participant data
            const chatDoc = await db.collection('chats').doc(chatId).get();
            const chatData = chatDoc.data();
            const otherUser = chatData.participantsData[otherUserId];
            
            // Update chat header
            document.getElementById('chatHeader').innerHTML = `
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="seller-avatar" style="width: 50px; height: 50px; font-size: 1.2rem;">
                        ${getInitials(otherUser.name)}
                    </div>
                    <div>
                        <h3 style="margin-bottom: 0.2rem;">${otherUser.name}</h3>
                        <p style="color: var(--success); margin: 0;">
                            <i class="fas fa-circle" style="font-size: 0.6rem;"></i> Online
                        </p>
                    </div>
                </div>
            `;
            
            // Show message area
            document.getElementById('messagesContainer').style.display = 'block';
            document.getElementById('messageInputContainer').style.display = 'flex';
            
            // Load messages
            loadMessages(chatId);
        }

        function loadMessages(chatId) {
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';
            
            // Unsubscribe from previous listener
            if (unsubscribeMessages) {
                unsubscribeMessages();
            }
            
            // Subscribe to messages
            unsubscribeMessages = db.collection('chats').doc(chatId)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot((snapshot) => {
                    messagesContainer.innerHTML = '';
                    
                    snapshot.forEach((doc) => {
                        const message = doc.data();
                        displayMessage(message);
                    });
                    
                    // Scroll to bottom
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                });
        }

        function displayMessage(message) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageElement = document.createElement('div');
            
            messageElement.className = `message ${message.senderId === AppState.currentUser.uid ? 'sent' : 'received'}`;
            messageElement.innerHTML = `
                ${message.message}
                <div class="message-time">${formatTime(message.timestamp)}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !currentChatId) return;
            
            try {
                await db.collection('chats').doc(currentChatId).collection('messages').add({
                    senderId: AppState.currentUser.uid,
                    senderName: AppState.userData.name,
                    message: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update last message
                await db.collection('chats').doc(currentChatId).update({
                    lastMessage: message,
                    lastMessageTime: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                messageInput.value = '';
                
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Error sending message', 'error');
            }
        }

        async function startNewChat(sellerId) {
            try {
                // Check if chat already exists
                const existingChat = await db.collection('chats')
                    .where('participants', 'array-contains', AppState.currentUser.uid)
                    .get();

                let chatExists = false;
                existingChat.forEach(doc => {
                    const chat = doc.data();
                    if (chat.participants.includes(sellerId)) {
                        chatExists = true;
                        loadChat(doc.id, sellerId);
                    }
                });

                if (!chatExists) {
                    // Get seller data
                    const sellerDoc = await db.collection('users').doc(sellerId).get();
                    const sellerData = sellerDoc.data();
                    
                    // Create new chat
                    const chatData = {
                        participants: [AppState.currentUser.uid, sellerId],
                        participantsData: {
                            [AppState.currentUser.uid]: {
                                name: AppState.userData.name,
                                avatar: getInitials(AppState.userData.name)
                            },
                            [sellerId]: {
                                name: sellerData.name,
                                avatar: getInitials(sellerData.name)
                            }
                        },
                        lastMessage: '',
                        lastMessageTime: firebase.firestore.FieldValue.serverTimestamp(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    const chatRef = await db.collection('chats').add(chatData);
                    loadChat(chatRef.id, sellerId);
                    
                    showNotification('Chat started successfully', 'success');
                }
                
            } catch (error) {
                console.error('Error starting chat:', error);
                showNotification('Error starting chat', 'error');
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate();
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Enter key to send message
        document.getElementById('messageInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>
