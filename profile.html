<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Trust Sell</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-shield-alt"></i> Trust Sell
            </div>
            <div class="nav-links">
                <a href="index.html">Home</a>
                <a href="products.html">Browse</a>
                <a href="post-ad.html" class="btn btn-primary">Sell Now</a>
            </div>
        </div>
    </nav>

    <!-- Profile Container -->
    <div class="profile-container">
        <!-- Sidebar -->
        <div class="profile-sidebar">
            <div class="user-card">
                <div class="profile-avatar" id="userAvatar">
                    <!-- Avatar will be loaded here -->
                </div>
                <h2 class="user-name" id="userName">Loading...</h2>
                <div class="user-verified" id="verificationBadge" style="display: none;">
                    <i class="fas fa-badge-check"></i> Verified Seller
                </div>
                <p id="memberSince">Member since Loading...</p>
            </div>

            <div class="profile-stats">
                <div class="stat">
                    <div class="stat-number" id="activeAdsCount">0</div>
                    <div class="stat-label">Active Ads</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="totalViews">0</div>
                    <div class="stat-label">Total Views</div>
                </div>
            </div>

            <div class="sidebar-menu">
                <div class="menu-item active" onclick="showSection('my-ads')">
                    <i class="fas fa-th-large"></i>
                    <span>My Ads</span>
                </div>
                <div class="menu-item" onclick="showSection('favorites')">
                    <i class="fas fa-heart"></i>
                    <span>Favorites</span>
                </div>
                <div class="menu-item" onclick="showSection('messages')">
                    <i class="fas fa-envelope"></i>
                    <span>Messages</span>
                </div>
                <div class="menu-item" onclick="showSection('reviews')">
                    <i class="fas fa-star"></i>
                    <span>Reviews</span>
                </div>
                <div class="menu-item" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
                <div class="menu-item" onclick="logoutUser()" style="color: var(--danger);">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="profile-content">
            <!-- My Ads Section -->
            <div class="content-section active" id="my-ads-section">
                <div class="content-header" style="display: flex; justify-content: between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #eee;">
                    <h2>My Active Ads</h2>
                    <a href="post-ad.html" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Post New Ad
                    </a>
                </div>

                <div class="ads-tabs" style="display: flex; gap: 1rem; margin-bottom: 2rem; background: var(--light); padding: 0.5rem; border-radius: 15px;">
                    <div class="ads-tab active" onclick="showAdsTab('active')">Active (<span id="activeCount">0</span>)</div>
                    <div class="ads-tab" onclick="showAdsTab('sold')">Sold (<span id="soldCount">0</span>)</div>
                    <div class="ads-tab" onclick="showAdsTab('pending')">Pending (<span id="pendingCount">0</span>)</div>
                </div>

                <div class="products-grid" id="myAdsContainer">
                    <!-- Ads will be loaded here -->
                    <div class="text-center" style="grid-column: 1/-1; padding: 3rem; color: #666;">
                        <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 1rem; color: #ddd;"></i>
                        <h3>No ads posted yet</h3>
                        <p>Start selling by posting your first ad</p>
                        <a href="post-ad.html" class="btn btn-primary mt-2">Post Your First Ad</a>
                    </div>
                </div>
            </div>

            <!-- Favorites Section -->
            <div class="content-section" id="favorites-section">
                <div class="content-header">
                    <h2>My Favorites</h2>
                </div>
                <div class="products-grid" id="favoritesContainer">
                    <div class="text-center" style="grid-column: 1/-1; padding: 3rem; color: #666;">
                        <i class="fas fa-heart" style="font-size: 3rem; margin-bottom: 1rem; color: #ddd;"></i>
                        <h3>No favorites yet</h3>
                        <p>Items you like will appear here</p>
                    </div>
                </div>
            </div>

            <!-- Messages Section -->
            <div class="content-section" id="messages-section">
                <div class="content-header">
                    <h2>Recent Messages</h2>
                </div>
                <div id="recentMessagesContainer">
                    <div class="text-center" style="padding: 3rem; color: #666;">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem; color: #ddd;"></i>
                        <h3>No messages yet</h3>
                        <p>Your conversations will appear here</p>
                        <a href="products.html" class="btn btn-primary mt-2">Browse Products</a>
                    </div>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="content-section" id="reviews-section">
                <div class="content-header">
                    <h2>My Reviews</h2>
                </div>
                <div id="reviewsContainer">
                    <div class="text-center" style="padding: 3rem; color: #666;">
                        <i class="fas fa-star" style="font-size: 3rem; margin-bottom: 1rem; color: #ddd;"></i>
                        <h3>No reviews yet</h3>
                        <p>Reviews from buyers will appear here</p>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div class="content-section" id="settings-section">
                <div class="content-header">
                    <h2>Account Settings</h2>
                </div>
                <div class="form-group">
                    <label for="settingsName">Full Name</label>
                    <input type="text" id="settingsName" class="form-control">
                </div>
                <div class="form-group">
                    <label for="settingsEmail">Email Address</label>
                    <input type="email" id="settingsEmail" class="form-control" disabled>
                </div>
                <div class="form-group">
                    <label for="settingsPhone">Phone Number</label>
                    <input type="tel" id="settingsPhone" class="form-control">
                </div>
                <div class="form-group">
                    <label for="settingsCity">City</label>
                    <select id="settingsCity" class="form-control">
                        <option value="">Select City</option>
                        <option value="Karachi">Karachi</option>
                        <option value="Lahore">Lahore</option>
                        <option value="Islamabad">Islamabad</option>
                        <option value="Rawalpindi">Rawalpindi</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="updateProfile()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="script.js"></script>

    <script>
        let currentAdsTab = 'active';
        let myProducts = [];

        // Check authentication
        auth.onAuthStateChanged((user) => {
            if (user) {
                loadProfileData();
                loadMyAds();
                loadFavorites();
            } else {
                showNotification('Please login to view profile', 'warning');
                setTimeout(() => {
                    window.location.href = 'auth.html';
                }, 2000);
            }
        });

        async function loadProfileData() {
            if (!AppState.userData) {
                // Reload user data
                const userDoc = await db.collection('users').doc(AppState.currentUser.uid).get();
                AppState.userData = userDoc.data();
            }

            // Update profile information
            document.getElementById('userName').textContent = AppState.userData.name;
            document.getElementById('userAvatar').textContent = getInitials(AppState.userData.name);
            document.getElementById('memberSince').textContent = `Member since ${formatDate(AppState.userData.createdAt)}`;
            
            if (AppState.userData.verified) {
                document.getElementById('verificationBadge').style.display = 'inline-block';
            }

            // Update settings form
            document.getElementById('settingsName').value = AppState.userData.name;
            document.getElementById('settingsEmail').value = AppState.userData.email;
            document.getElementById('settingsPhone').value = AppState.userData.phone || '';
            document.getElementById('settingsCity').value = AppState.userData.city || '';
        }

        async function loadMyAds() {
            try {
                const productsSnapshot = await db.collection('products')
                    .where('sellerId', '==', AppState.currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .get();

                myProducts = [];
                let activeCount = 0, soldCount = 0, pendingCount = 0;
                let totalViews = 0;

                productsSnapshot.forEach((doc) => {
                    const product = {
                        id: doc.id,
                        ...doc.data()
                    };
                    myProducts.push(product);

                    // Count by status
                    if (product.status === 'active') activeCount++;
                    if (product.status === 'sold') soldCount++;
                    if (product.status === 'pending') pendingCount++;

                    totalViews += product.views || 0;
                });

                // Update counts
                document.getElementById('activeAdsCount').textContent = activeCount;
                document.getElementById('totalViews').textContent = totalViews;
                document.getElementById('activeCount').textContent = activeCount;
                document.getElementById('soldCount').textContent = soldCount;
                document.getElementById('pendingCount').textContent = pendingCount;

                // Display ads
                displayMyAds();

            } catch (error) {
                console.error('Error loading ads:', error);
                showNotification('Error loading your ads', 'error');
            }
        }

        function displayMyAds() {
            const container = document.getElementById('myAdsContainer');
            const filteredProducts = myProducts.filter(product => 
                currentAdsTab === 'active' ? product.status === 'active' :
                currentAdsTab === 'sold' ? product.status === 'sold' :
                product.status === 'pending'
            );

            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="text-center" style="grid-column: 1/-1; padding: 3rem; color: #666;">
                        <i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 1rem; color: #ddd;"></i>
                        <h3>No ${currentAdsTab} ads</h3>
                        <p>${getNoAdsMessage(currentAdsTab)}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                productCard.innerHTML = `
                    <div class="product-image">
                        <i class="fas fa-${getCategoryIcon(product.category)}"></i>
                        <div class="product-badge status-${product.status}">
                            ${product.status.charAt(0).toUpperCase() + product.status.slice(1)}
                        </div>
                    </div>
                    <div class="product-content">
                        <h3 class="product-title">${product.title}</h3>
                        <div class="product-price">${formatPrice(product.price)}</div>
                        <div class="product-location">
                            <i class="fas fa-map-marker-alt"></i> ${product.location}
                        </div>
                        <div class="product-meta">
                            <div>
                                <small style="color: #666;">Views: ${product.views || 0}</small>
                            </div>
                            <div class="product-actions">
                                <button class="action-btn btn-edit" onclick="editAd('${product.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn btn-delete" onclick="deleteAd('${product.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.appendChild(productCard);
            });
        }

        function getNoAdsMessage(tab) {
            const messages = {
                'active': 'You have no active ads at the moment',
                'sold': 'You haven\'t sold any items yet',
                'pending': 'You have no pending ads'
            };
            return messages[tab] || 'No ads found';
        }

        async function loadFavorites() {
            try {
                const favoritesSnapshot = await db.collection('favorites')
                    .where('userId', '==', AppState.currentUser.uid)
                    .get();

                if (favoritesSnapshot.empty) {
                    return;
                }

                const favoriteIds = [];
                favoritesSnapshot.forEach(doc => {
                    favoriteIds.push(doc.data().productId);
                });

                // Load favorite products
                const productsSnapshot = await db.collection('products')
                    .where('status', '==', 'active')
                    .get();

                const favoritesContainer = document.getElementById('favoritesContainer');
                favoritesContainer.innerHTML = '';

                productsSnapshot.forEach(doc => {
                    if (favoriteIds.includes(doc.id)) {
                        const product = doc.data();
                        const productCard = document.createElement('div');
                        productCard.className = 'product-card';
                        productCard.onclick = () => viewProduct(doc.id);
                        
                        productCard.innerHTML = `
                            <div class="product-image">
                                <i class="fas fa-${getCategoryIcon(product.category)}"></i>
                            </div>
                            <div class="product-content">
                                <h3 class="product-title">${product.title}</h3>
                                <div class="product-price">${formatPrice(product.price)}</div>
                                <div class="product-location">
                                    <i class="fas fa-map-marker-alt"></i> ${product.location}
                                </div>
                            </div>
                        `;
                        
                        favoritesContainer.appendChild(productCard);
                    }
                });

            } catch (error) {
                console.error('Error loading favorites:', error);
            }
        }

        function showSection(section) {
            // Update menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.menu-item').classList.add('active');

            // Update content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(section + '-section').classList.add('active');
        }

        function showAdsTab(tab) {
            currentAdsTab = tab;
            
            document.querySelectorAll('.ads-tab').forEach(tabEl => {
                tabEl.classList.remove('active');
            });
            event.target.classList.add('active');

            displayMyAds();
        }

        function editAd(productId) {
            showNotification('Edit feature coming soon!', 'info');
        }

        async function deleteAd(productId) {
            if (!confirm('Are you sure you want to delete this ad?')) {
                return;
            }

            try {
                await db.collection('products').doc(productId).update({
                    status: 'deleted'
                });
                
                showNotification('Ad deleted successfully', 'success');
                loadMyAds();
                
            } catch (error) {
                console.error('Error deleting ad:', error);
                showNotification('Error deleting ad', 'error');
            }
        }

        async function updateProfile() {
            const name = document.getElementById('settingsName').value.trim();
            const phone = document.getElementById('settingsPhone').value.trim();
            const city = document.getElementById('settingsCity').value;

            if (!name) {
                showNotification('Please enter your name', 'error');
                return;
            }

            showLoading('Updating profile...');

            try {
                await db.collection('users').doc(AppState.currentUser.uid).update({
                    name: name,
                    phone: phone,
                    city: city,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Update global state
                AppState.userData.name = name;
                AppState.userData.phone = phone;
                AppState.userData.city = city;

                // Update UI
                document.getElementById('userName').textContent = name;
                document.getElementById('userAvatar').textContent = getInitials(name);

                showNotification('Profile updated successfully', 'success');
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showNotification('Error updating profile', 'error');
            } finally {
                hideLoading();
            }
        }

        // Add CSS for status badges
        const style = document.createElement('style');
        style.textContent = `
            .status-active { background: var(--success); }
            .status-sold { background: var(--primary); }
            .status-pending { background: var(--warning); color: var(--dark); }
            .status-deleted { background: var(--danger); }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
